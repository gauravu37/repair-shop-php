import{a as E}from"./chunk-WFL6JKVB.js";import"./chunk-5LCWTLC6.js";import{A as ve,B as be,a as X,b as Y,c as u,d as Z,e as ee,f as te,l as ie,m as ne,o as re,p as oe,q as le,r as ae,s as me,t as de,u as ce,v as se,w as pe,x as ue,y as _e}from"./chunk-KU4YNCMP.js";import"./chunk-6AF7U7KC.js";import{Aa as z,Ea as K,I as J,Ja as Q,La as W,Z as O,_ as B,ba as $,c as G,j as R,l as L,wa as U,za as H}from"./chunk-QPBR7IA7.js";import{Bc as C,Cc as x,Eb as m,Pb as o,Qb as i,Rb as f,Sb as D,Tb as A,Vb as j,Yb as y,_b as b,ab as a,bd as N,cd as P,fb as g,gd as q,jd as M,ka as S,la as F,lc as l,ld as w,mc as T,nc as h,ob as I,oc as V,ub as _,wc as k}from"./chunk-L5V4HGA2.js";import"./chunk-Q7L6LLAK.js";function fe(r,c){if(r&1&&(o(0,"option",20),l(1),i()),r&2){let e=c.$implicit;m("value",e.id),a(),V(" ",e.full_name," (",e.phone,") ")}}function he(r,c){r&1&&(o(0,"div",21),l(1," Customer selection is required "),i())}function ge(r,c){if(r&1&&(o(0,"option",20),l(1),C(2,"titlecase"),i()),r&2){let e=c.$implicit;m("value",e),a(),h(" ",x(2,2,e)," ")}}function ye(r,c){r&1&&(o(0,"div",21),l(1," Device type is required "),i())}function Ce(r,c){r&1&&(o(0,"div",21),l(1," Description is required and must be at least 10 characters "),i())}function xe(r,c){r&1&&(o(0,"div",21),l(1," Valid price is required "),i())}function Ee(r,c){if(r&1&&(o(0,"c-col",12)(1,"label",24),l(2,"Replacement Serial Number *"),i(),f(3,"input",31),i()),r&2){let e,t=b(),n=t.$implicit,d=t.index;a(),m("for","replacement_srno_"+d),a(2),m("id","replacement_srno_"+d)("required",(e=n.get("needs_replacement"))==null?null:e.value)}}function Se(r,c){if(r&1){let e=j();o(0,"c-col",0)(1,"button",32),y("click",function(){S(e);let n=b().index,d=b();return F(d.removeDevice(n))}),l(2," Remove Device "),i()()}}function Fe(r,c){if(r&1){let e=j();o(0,"div",22)(1,"h5"),l(2),i(),o(3,"c-row",23)(4,"c-col",12)(5,"label",24),l(6,"Device Type *"),i(),o(7,"select",25)(8,"option",6),l(9,"Select device type..."),i(),_(10,ge,3,4,"option",7),i(),_(11,ye,2,0,"div",8),i(),o(12,"c-col",12)(13,"label",24),l(14,"Problem Description *"),i(),f(15,"textarea",26),_(16,Ce,2,0,"div",8),i(),o(17,"c-col",12)(18,"label",24),l(19,"Estimated Price ($) *"),i(),f(20,"input",27),_(21,xe,2,0,"div",8),i(),o(22,"c-col",12)(23,"label",24),l(24,"Serial Number"),i(),f(25,"input",28),i(),o(26,"c-col",12)(27,"label",17)(28,"input",29),y("change",function(){let n=S(e).index,d=b();return F(d.onReplacementChange(n))}),i(),l(29," Needs Replacement "),i()(),_(30,Ee,4,3,"c-col",15)(31,Se,3,0,"c-col",30),i()()}if(r&2){let e,t,n,d,p=c.$implicit,v=c.index,s=b();m("formGroupName",v),a(2),h("Device #",v+1,""),a(3),m("for","deviceType_"+v),a(2),m("id","deviceType_"+v),a(3),m("ngForOf",s.itemTypes),a(),m("ngIf",((e=p.get("device_type"))==null?null:e.invalid)&&((e=p.get("device_type"))==null?null:e.touched)),a(2),m("for","problemDesc_"+v),a(2),m("id","problemDesc_"+v),a(),m("ngIf",((t=p.get("problem_description"))==null?null:t.invalid)&&((t=p.get("problem_description"))==null?null:t.touched)),a(2),m("for","estimatedPrice_"+v),a(2),m("id","estimatedPrice_"+v),a(),m("ngIf",((n=p.get("estimated_price"))==null?null:n.invalid)&&((n=p.get("estimated_price"))==null?null:n.touched)),a(2),m("for","srno_"+v),a(2),m("id","srno_"+v),a(5),m("ngIf",(d=p.get("needs_replacement"))==null?null:d.value),a(),m("ngIf",s.devices.length>1)}}function je(r,c){r&1&&(o(0,"div",21),l(1," Delivery date is required "),i())}function Ie(r,c){r&1&&(o(0,"c-col",12)(1,"label",33),l(2,"Status"),i(),o(3,"select",34)(4,"option",35),l(5,"Pending"),i(),o(6,"option",36),l(7,"In Progress"),i(),o(8,"option",37),l(9,"Completed"),i()()())}function De(r,c){r&1&&(o(0,"div",21),l(1," Payment status is required "),i())}function Ae(r,c){if(r&1&&(o(0,"option",20),l(1),C(2,"titlecase"),i()),r&2){let e=c.$implicit;m("value",e),a(),h(" ",x(2,2,e.replace("_"," "))," ")}}function Te(r,c){r&1&&(o(0,"div",21),l(1," Payment method is required "),i())}function Ve(r,c){if(r&1&&(o(0,"c-col",12)(1,"label",41),l(2,"Payment Method *"),i(),o(3,"select",42),_(4,Ae,3,4,"option",7),i(),_(5,Te,2,0,"div",8),i()),r&2){let e,t=b(2);a(4),m("ngForOf",t.paymentMethods),a(),m("ngIf",((e=t.jobForm.get("payment_method"))==null?null:e.invalid)&&((e=t.jobForm.get("payment_method"))==null?null:e.touched))}}function ke(r,c){r&1&&(o(0,"div",21),l(1," Valid UPI link is required "),i())}function Ne(r,c){if(r&1&&(o(0,"c-col",12)(1,"label",43),l(2,"UPI Payment Link *"),i(),f(3,"input",44),_(4,ke,2,0,"div",8),i()),r&2){let e,t=b(2);a(4),m("ngIf",((e=t.jobForm.get("upi_link"))==null?null:e.invalid)&&((e=t.jobForm.get("upi_link"))==null?null:e.touched))}}function Pe(r,c){if(r&1&&(D(0),o(1,"c-col",3)(2,"h5"),l(3,"Payment Information"),i()(),o(4,"c-col",12)(5,"label",38),l(6,"Payment Status *"),i(),o(7,"select",39)(8,"option",35),l(9,"Pending"),i(),o(10,"option",40),l(11,"Paid"),i()(),_(12,De,2,0,"div",8),i(),_(13,Ve,6,2,"c-col",15)(14,Ne,5,1,"c-col",15),A()),r&2){let e,t,n,d=b();a(12),m("ngIf",((e=d.jobForm.get("payment_status"))==null?null:e.invalid)&&((e=d.jobForm.get("payment_status"))==null?null:e.touched)),a(),m("ngIf",((t=d.jobForm.get("payment_status"))==null?null:t.value)==="paid"),a(),m("ngIf",((n=d.jobForm.get("payment_status"))==null?null:n.value)==="pending")}}var et=(()=>{class r{constructor(e,t,n,d){this.fb=e,this.jobService=t,this.router=n,this.route=d,this.isEditMode=!1,this.jobId=null,this.paymentMethods=["cash","bank_transfer","upi"],this.showPaymentForm=!1,this.customers=[],this.itemTypes=["laptop","desktop","printer","monitor","phone","tablet","other"],this.minDate=new Date().toISOString().split("T")[0],this.jobForm=this.fb.group({user_id:["",u.required],devices:this.fb.array([this.createDeviceFormGroup()]),estimated_delivery:["",u.required],status:["pending"],upi_link:[null],payment_status:["pending",u.required],payment_method:[null]})}ngOnInit(){this.loadCustomers(),this.route.paramMap.subscribe(e=>{let t=e.get("id");t&&(this.isEditMode=!0,this.jobId=+t,this.loadJob(this.jobId))}),this.devices.controls.forEach(e=>{e.get("needs_replacement")?.valueChanges.subscribe(t=>{t||e.get("replacement_serial_number")?.setValue("")})}),this.devices.controls.forEach((e,t)=>{e.get("needs_replacement")?.valueChanges.subscribe(n=>{this.onReplacementChange(t)})}),this.jobForm.get("status")?.valueChanges.subscribe(e=>{this.showPaymentForm=e==="completed",e==="completed"?this.jobForm.get("payment_status")?.setValidators([u.required]):this.jobForm.get("payment_status")?.clearValidators(),this.jobForm.get("payment_status")?.updateValueAndValidity()}),this.jobForm.get("payment_status")?.valueChanges.subscribe(e=>{let t=this.jobForm.get("payment_method"),n=this.jobForm.get("upi_link");e==="paid"?(t?.setValidators([u.required]),n?.clearValidators()):e==="pending"&&t?.clearValidators(),t?.updateValueAndValidity(),n?.updateValueAndValidity()})}loadJob(e){this.jobService.getJob(e).subscribe({next:t=>{for(;this.devices.length;)this.devices.removeAt(0);this.jobForm.patchValue({user_id:t.user_id,estimated_delivery:t.estimated_delivery,status:t.status,payment_status:t.payment_status||"pending",payment_method:t.payment_method,upi_link:t.upi_link}),t.devices.forEach(n=>{this.devices.push(this.fb.group({device_type:[n.device_type,u.required],problem_description:[n.problem_description,[u.required,u.minLength(10)]],estimated_price:[n.estimated_price,[u.required,u.min(0)]],serial_number:[n.serial_number||""],needs_replacement:[n.needs_replacement||!1],replacement_serial_number:[n.replacement_serial_number||""]}))}),this.showPaymentForm=t.status==="completed"},error:t=>console.error("Error loading job:",t)})}onReplacementChange(e){let t=this.devices.at(e);t.get("needs_replacement")?.value??!1?t.get("replacement_serial_number")?.setValidators([u.required]):(t.get("replacement_serial_number")?.clearValidators(),t.get("replacement_serial_number")?.setValue("")),t.get("replacement_serial_number")?.updateValueAndValidity()}get devices(){return this.jobForm.get("devices")}createDeviceFormGroup(){return this.fb.group({device_type:["",u.required],problem_description:["",[u.required,u.minLength(10)]],estimated_price:["",[u.required,u.min(0)]],serial_number:[""],needs_replacement:[!1],replacement_serial_number:[""]})}addDevice(){this.devices.push(this.createDeviceFormGroup())}removeDevice(e){this.devices.removeAt(e)}loadCustomers(){this.jobService.getCustomers().subscribe({next:e=>this.customers=e.records||e,error:e=>console.error("Error loading customers:",e)})}calculateTotalPrice(){return this.devices.controls.reduce((e,t)=>e+(+t.get("estimated_price")?.value||0),0)}onSubmit(){this.markFormGroupTouched(this.jobForm);let e=!1;this.devices.controls.forEach(s=>{s.get("needs_replacement")?.value&&!s.get("replacement_serial_number")?.value&&(s.get("replacement_serial_number")?.setErrors({required:!0}),e=!0)});let t=!1;if(this.devices.controls.forEach(s=>{s.get("needs_replacement")?.value&&!s.get("replacement_serial_number")?.value&&(s.get("replacement_serial_number")?.setErrors({required:!0}),t=!0)}),this.jobForm.invalid||t){alert("Please fill all required fields");return}if(this.devices.length===0){alert("Please add at least one device");return}let n=this.jobForm.value.devices[0],d=this.jobForm.value,p={user_id:d.user_id,estimated_delivery:d.estimated_delivery,estimated_price:this.calculateTotalPrice(),devices:d.devices.map(s=>({device_type:s.device_type,problem_description:s.problem_description,estimated_price:s.estimated_price,serial_number:s.serial_number,needs_replacement:s.needs_replacement,replacement_serial_number:s.needs_replacement?s.replacement_serial_number:null})),item_type:n.device_type,problem_description:n.problem_description,serial_number:n.serial_number,needs_replacement:n.needs_replacement,status:d.status};this.isEditMode&&(p.payment_status=d.payment_status,p.payment_method=d.payment_method,p.upi_link=d.upi_link),(this.isEditMode&&this.jobId?this.jobService.updateJob(this.jobId,p):this.jobService.createJob(p)).subscribe({next:()=>{let s=`Job ${this.isEditMode?"updated":"created"} successfully!`;alert(s),d.status==="completed"&&this.generateInvoice(),this.router.navigate(["base/jobs"])},error:s=>{console.error(`Error ${this.isEditMode?"updating":"creating"} job:`,s),alert(`Error ${this.isEditMode?"updating":"creating"} job. Please try again.`)}})}generateInvoice(){this.jobId&&this.jobService.generateInvoice(this.jobId).subscribe({next:()=>alert("Invoice generated and sent to customer"),error:e=>console.error("Failed to generate invoice:",e)})}markFormGroupTouched(e){Object.values(e.controls).forEach(t=>{t.markAsTouched(),(t instanceof te||t instanceof ue)&&this.markFormGroupTouched(t)})}static{this.\u0275fac=function(t){return new(t||r)(g(_e),g(E),g(L),g(R))}}static{this.\u0275cmp=I({type:r,selectors:[["app-addjob"]],features:[k([E])],decls:39,vars:13,consts:[["xs","12"],[1,"mb-4"],["cForm","",1,"row","g-3",3,"ngSubmit","formGroup"],["md","12"],["cLabel","","for","inputCustomer"],["cSelect","","id","inputCustomer","formControlName","user_id"],["value",""],[3,"value",4,"ngFor","ngForOf"],["class","text-danger",4,"ngIf"],["formArrayName","devices",1,"col-12"],["class","mb-4 p-3 border rounded",3,"formGroupName",4,"ngFor","ngForOf"],["cButton","","color","secondary","type","button",3,"click"],["md","6"],["cLabel","","for","estimatedDelivery"],["type","date","cFormControl","","id","estimatedDelivery","formControlName","estimated_delivery",3,"min"],["md","6",4,"ngIf"],[4,"ngIf"],["cLabel",""],[1,"form-control"],["cButton","","color","primary","type","submit"],[3,"value"],[1,"text-danger"],[1,"mb-4","p-3","border","rounded",3,"formGroupName"],[1,"g-3"],["cLabel","",3,"for"],["cSelect","","formControlName","device_type",3,"id"],["cFormControl","","formControlName","problem_description","rows","3",3,"id"],["type","number","cFormControl","","formControlName","estimated_price","min","0","step","0.01",3,"id"],["type","text","cFormControl","","formControlName","serial_number","min","0","step","0.01",3,"id"],["type","checkbox","formControlName","needs_replacement",3,"change"],["xs","12",4,"ngIf"],["type","text","cFormControl","","formControlName","replacement_serial_number",3,"id","required"],["cButton","","color","danger","type","button",3,"click"],["cLabel","","for","status"],["cSelect","","id","status","formControlName","status"],["value","pending"],["value","in_progress"],["value","completed"],["cLabel","","for","paymentStatus"],["cSelect","","id","paymentStatus","formControlName","payment_status"],["value","paid"],["cLabel","","for","paymentMethod"],["cSelect","","id","paymentMethod","formControlName","payment_method"],["cLabel","","for","upiLink"],["type","url","cFormControl","","id","upiLink","formControlName","upi_link","placeholder","https://upi.link/..."]],template:function(t,n){if(t&1&&(o(0,"c-row")(1,"c-col",0)(2,"c-card",1)(3,"c-card-header"),l(4,`
        `),o(5,"strong"),l(6),i(),l(7,`
      `),i(),o(8,"c-card-body")(9,"form",2),y("ngSubmit",function(){return n.onSubmit()}),o(10,"c-col",3)(11,"label",4),l(12,"Customer *"),i(),o(13,"select",5)(14,"option",6),l(15,"Select customer..."),i(),_(16,fe,2,3,"option",7),i(),_(17,he,2,0,"div",8),i(),o(18,"div",9),_(19,Fe,32,16,"div",10),i(),o(20,"c-col",0)(21,"button",11),y("click",function(){return n.addDevice()}),l(22," + Add Another Device "),i()(),o(23,"c-col",12)(24,"label",13),l(25,"Estimated Delivery Date *"),i(),f(26,"input",14),_(27,je,2,0,"div",8),i(),_(28,Ie,10,0,"c-col",15)(29,Pe,15,3,"ng-container",16),o(30,"c-col",12)(31,"label",17),l(32,"Total Estimated Price"),i(),o(33,"div",18),l(34),C(35,"currency"),i()(),o(36,"c-col",0)(37,"button",19),l(38),i()()()()()()()),t&2){let d,p;a(6),T(n.isEditMode?"Edit Repair Job":"Create New Repair Job"),a(3),m("formGroup",n.jobForm),a(7),m("ngForOf",n.customers),a(),m("ngIf",((d=n.jobForm.get("user_id"))==null?null:d.invalid)&&((d=n.jobForm.get("user_id"))==null?null:d.touched)),a(2),m("ngForOf",n.devices.controls),a(7),m("min",n.minDate),a(),m("ngIf",((p=n.jobForm.get("estimated_delivery"))==null?null:p.invalid)&&((p=n.jobForm.get("estimated_delivery"))==null?null:p.touched)),a(),m("ngIf",n.isEditMode),a(),m("ngIf",n.showPaymentForm&&n.isEditMode),a(5),h(" ",x(35,11,n.calculateTotalPrice())," "),a(4),h(" ",n.isEditMode?"Update Job":"Create Job"," ")}},dependencies:[w,N,P,q,M,G,be,ie,de,ce,Y,ne,X,me,Z,ee,pe,se,re,ae,oe,le,W,Q,O,$,B,K,U,z,J,ve,H],encapsulation:2})}}return r})();export{et as AddjobComponent};
