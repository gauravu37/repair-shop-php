import{a as x}from"./chunk-VGZTR5F4.js";import"./chunk-2FK3AD3G.js";import{A as ye,B as Ee,a as ne,b as oe,c as u,d as re,e as le,f as ae,l as me,m as de,o as se,p as ce,q as pe,r as ue,s as _e,t as be,u as ve,v as he,w as fe,x as ge,y as Ce}from"./chunk-U632TBKN.js";import"./chunk-EB6Q3PFJ.js";import{$ as O,Aa as U,Ba as z,Fa as K,J,Ka as Q,Ma as W,_ as B,_a as X,ab as Y,bb as Z,ca as $,cb as ee,d as G,db as te,eb as ie,k as L,m as R,xa as H}from"./chunk-52S2453R.js";import{Bc as y,Cc as E,Eb as m,Pb as o,Qb as t,Rb as v,Sb as I,Tb as T,Vb as j,Yb as h,_b as f,ab as a,bd as k,cd as V,fb as C,gd as w,jd as P,ka as S,la as F,lc as r,ld as q,mc as M,nc as g,ob as A,oc as D,ub as _,wc as N}from"./chunk-PZC2ALTS.js";import"./chunk-Q7L6LLAK.js";function xe(l,s){if(l&1&&(o(0,"option",34),r(1),t()),l&2){let e=s.$implicit;m("value",e.id),a(),D(" ",e.full_name," (",e.phone,") ")}}function Se(l,s){l&1&&(o(0,"div",35),r(1," Customer selection is required "),t())}function Fe(l,s){if(l&1&&(o(0,"option",34),r(1),y(2,"titlecase"),t()),l&2){let e=s.$implicit;m("value",e),a(),g(" ",E(2,2,e)," ")}}function je(l,s){l&1&&(o(0,"div",35),r(1," Device type is required "),t())}function Ae(l,s){l&1&&(o(0,"div",35),r(1," Description is required and must be at least 10 characters "),t())}function Ie(l,s){l&1&&(o(0,"div",35),r(1," Valid price is required "),t())}function Te(l,s){if(l&1&&(o(0,"c-col",14)(1,"label",37),r(2,"Replacement Serial Number *"),t(),v(3,"input",44),t()),l&2){let e,i=f(),n=i.$implicit,d=i.index;a(),m("for","replacement_srno_"+d),a(2),m("id","replacement_srno_"+d)("required",(e=n.get("needs_replacement"))==null?null:e.value)}}function Me(l,s){if(l&1){let e=j();o(0,"c-col",0)(1,"button",45),h("click",function(){S(e);let n=f().index,d=f();return F(d.removeDevice(n))}),r(2," Remove Device "),t()()}}function De(l,s){if(l&1){let e=j();o(0,"div",36)(1,"h5"),r(2),t(),o(3,"c-row",13)(4,"c-col",14)(5,"label",37),r(6,"Device Type *"),t(),o(7,"select",38)(8,"option",6),r(9,"Select device type..."),t(),_(10,Fe,3,4,"option",7),t(),_(11,je,2,0,"div",9),t(),o(12,"c-col",14)(13,"label",37),r(14,"Problem Description *"),t(),v(15,"textarea",39),_(16,Ae,2,0,"div",9),t(),o(17,"c-col",14)(18,"label",37),r(19,"Estimated Price ($) *"),t(),v(20,"input",40),_(21,Ie,2,0,"div",9),t(),o(22,"c-col",14)(23,"label",37),r(24,"Serial Number"),t(),v(25,"input",41),t(),o(26,"c-col",14)(27,"label",31)(28,"input",42),h("change",function(){let n=S(e).index,d=f();return F(d.onReplacementChange(n))}),t(),r(29," Needs Replacement "),t()(),_(30,Te,4,3,"c-col",29)(31,Me,3,0,"c-col",43),t()()}if(l&2){let e,i,n,d,p=s.$implicit,b=s.index,c=f();m("formGroupName",b),a(2),g("Device #",b+1,""),a(3),m("for","deviceType_"+b),a(2),m("id","deviceType_"+b),a(3),m("ngForOf",c.itemTypes),a(),m("ngIf",((e=p.get("device_type"))==null?null:e.invalid)&&((e=p.get("device_type"))==null?null:e.touched)),a(2),m("for","problemDesc_"+b),a(2),m("id","problemDesc_"+b),a(),m("ngIf",((i=p.get("problem_description"))==null?null:i.invalid)&&((i=p.get("problem_description"))==null?null:i.touched)),a(2),m("for","estimatedPrice_"+b),a(2),m("id","estimatedPrice_"+b),a(),m("ngIf",((n=p.get("estimated_price"))==null?null:n.invalid)&&((n=p.get("estimated_price"))==null?null:n.touched)),a(2),m("for","srno_"+b),a(2),m("id","srno_"+b),a(5),m("ngIf",(d=p.get("needs_replacement"))==null?null:d.value),a(),m("ngIf",c.devices.length>1)}}function Ne(l,s){l&1&&(o(0,"div",35),r(1," Delivery date is required "),t())}function ke(l,s){l&1&&(o(0,"c-col",14)(1,"label",46),r(2,"Status"),t(),o(3,"select",47)(4,"option",48),r(5,"Pending"),t(),o(6,"option",49),r(7,"In Progress"),t(),o(8,"option",50),r(9,"Completed"),t()()())}function Ve(l,s){l&1&&(o(0,"div",35),r(1," Payment status is required "),t())}function we(l,s){if(l&1&&(o(0,"option",34),r(1),y(2,"titlecase"),t()),l&2){let e=s.$implicit;m("value",e),a(),g(" ",E(2,2,e.replace("_"," "))," ")}}function Pe(l,s){l&1&&(o(0,"div",35),r(1," Payment method is required "),t())}function qe(l,s){if(l&1&&(o(0,"c-col",14)(1,"label",54),r(2,"Payment Method *"),t(),o(3,"select",55),_(4,we,3,4,"option",7),t(),_(5,Pe,2,0,"div",9),t()),l&2){let e,i=f(2);a(4),m("ngForOf",i.paymentMethods),a(),m("ngIf",((e=i.jobForm.get("payment_method"))==null?null:e.invalid)&&((e=i.jobForm.get("payment_method"))==null?null:e.touched))}}function Ge(l,s){l&1&&(o(0,"div",35),r(1," Valid UPI link is required "),t())}function Le(l,s){if(l&1&&(o(0,"c-col",14)(1,"label",56),r(2,"UPI Payment Link *"),t(),v(3,"input",57),_(4,Ge,2,0,"div",9),t()),l&2){let e,i=f(2);a(4),m("ngIf",((e=i.jobForm.get("upi_link"))==null?null:e.invalid)&&((e=i.jobForm.get("upi_link"))==null?null:e.touched))}}function Re(l,s){if(l&1&&(I(0),o(1,"c-col",3)(2,"h5"),r(3,"Payment Information"),t()(),o(4,"c-col",14)(5,"label",51),r(6,"Payment Status *"),t(),o(7,"select",52)(8,"option",48),r(9,"Pending"),t(),o(10,"option",53),r(11,"Paid"),t()(),_(12,Ve,2,0,"div",9),t(),_(13,qe,6,2,"c-col",29)(14,Le,5,1,"c-col",29),T()),l&2){let e,i,n,d=f();a(12),m("ngIf",((e=d.jobForm.get("payment_status"))==null?null:e.invalid)&&((e=d.jobForm.get("payment_status"))==null?null:e.touched)),a(),m("ngIf",((i=d.jobForm.get("payment_status"))==null?null:i.value)==="paid"),a(),m("ngIf",((n=d.jobForm.get("payment_status"))==null?null:n.value)==="pending")}}var mt=(()=>{class l{constructor(e,i,n,d){this.fb=e,this.jobService=i,this.router=n,this.route=d,this.isEditMode=!1,this.jobId=null,this.paymentMethods=["cash","bank_transfer","upi"],this.showPaymentForm=!1,this.isSavingCustomer=!1,this.showAddCustomerModal=!1,this.customers=[],this.itemTypes=["laptop","desktop","printer","monitor","phone","tablet","other"],this.minDate=new Date().toISOString().split("T")[0],this.jobForm=this.fb.group({user_id:["",u.required],devices:this.fb.array([this.createDeviceFormGroup()]),estimated_delivery:["",u.required],status:["pending"],upi_link:[null],payment_status:["pending",u.required],payment_method:[null]}),this.customerForm=this.fb.group({full_name:["",u.required],phone:["",u.required],email:[""],address:[""]})}ngOnInit(){this.loadCustomers(),this.route.paramMap.subscribe(e=>{let i=e.get("id");i&&(this.isEditMode=!0,this.jobId=+i,this.loadJob(this.jobId))}),this.devices.controls.forEach(e=>{e.get("needs_replacement")?.valueChanges.subscribe(i=>{i||e.get("replacement_serial_number")?.setValue("")})}),this.devices.controls.forEach((e,i)=>{e.get("needs_replacement")?.valueChanges.subscribe(n=>{this.onReplacementChange(i)})}),this.jobForm.get("status")?.valueChanges.subscribe(e=>{this.showPaymentForm=e==="completed",e==="completed"?this.jobForm.get("payment_status")?.setValidators([u.required]):this.jobForm.get("payment_status")?.clearValidators(),this.jobForm.get("payment_status")?.updateValueAndValidity()}),this.jobForm.get("payment_status")?.valueChanges.subscribe(e=>{let i=this.jobForm.get("payment_method"),n=this.jobForm.get("upi_link");e==="paid"?(i?.setValidators([u.required]),n?.clearValidators()):e==="pending"&&i?.clearValidators(),i?.updateValueAndValidity(),n?.updateValueAndValidity()})}loadJob(e){this.jobService.getJob(e).subscribe({next:i=>{for(;this.devices.length;)this.devices.removeAt(0);this.jobForm.patchValue({user_id:i.user_id,estimated_delivery:i.estimated_delivery,status:i.status,payment_status:i.payment_status||"pending",payment_method:i.payment_method,upi_link:i.upi_link}),i.devices.forEach(n=>{this.devices.push(this.fb.group({device_type:[n.device_type,u.required],problem_description:[n.problem_description,[u.required,u.minLength(10)]],estimated_price:[n.estimated_price,[u.required,u.min(0)]],serial_number:[n.serial_number||""],needs_replacement:[n.needs_replacement||!1],replacement_serial_number:[n.replacement_serial_number||""]}))}),this.showPaymentForm=i.status==="completed"},error:i=>console.error("Error loading job:",i)})}onReplacementChange(e){let i=this.devices.at(e);i.get("needs_replacement")?.value??!1?i.get("replacement_serial_number")?.setValidators([u.required]):(i.get("replacement_serial_number")?.clearValidators(),i.get("replacement_serial_number")?.setValue("")),i.get("replacement_serial_number")?.updateValueAndValidity()}get devices(){return this.jobForm.get("devices")}createDeviceFormGroup(){return this.fb.group({device_type:["",u.required],problem_description:["",[u.required,u.minLength(10)]],estimated_price:["",[u.required,u.min(0)]],serial_number:[""],needs_replacement:[!1],replacement_serial_number:[""]})}addDevice(){this.devices.push(this.createDeviceFormGroup())}removeDevice(e){this.devices.removeAt(e)}loadCustomers(){this.jobService.getCustomers().subscribe({next:e=>this.customers=e.records||e,error:e=>console.error("Error loading customers:",e)})}calculateTotalPrice(){return this.devices.controls.reduce((e,i)=>e+(+i.get("estimated_price")?.value||0),0)}onSubmit(){this.markFormGroupTouched(this.jobForm);let e=!1;this.devices.controls.forEach(c=>{c.get("needs_replacement")?.value&&!c.get("replacement_serial_number")?.value&&(c.get("replacement_serial_number")?.setErrors({required:!0}),e=!0)});let i=!1;if(this.devices.controls.forEach(c=>{c.get("needs_replacement")?.value&&!c.get("replacement_serial_number")?.value&&(c.get("replacement_serial_number")?.setErrors({required:!0}),i=!0)}),this.jobForm.invalid||i){alert("Please fill all required fields");return}if(this.devices.length===0){alert("Please add at least one device");return}let n=this.jobForm.value.devices[0],d=this.jobForm.value,p={user_id:d.user_id,estimated_delivery:d.estimated_delivery,estimated_price:this.calculateTotalPrice(),devices:d.devices.map(c=>({device_type:c.device_type,problem_description:c.problem_description,estimated_price:c.estimated_price,serial_number:c.serial_number,needs_replacement:c.needs_replacement,replacement_serial_number:c.needs_replacement?c.replacement_serial_number:null})),item_type:n.device_type,problem_description:n.problem_description,serial_number:n.serial_number,needs_replacement:n.needs_replacement,status:d.status};this.isEditMode&&(p.payment_status=d.payment_status,p.payment_method=d.payment_method,p.upi_link=d.upi_link),(this.isEditMode&&this.jobId?this.jobService.updateJob(this.jobId,p):this.jobService.createJob(p)).subscribe({next:()=>{let c=`Job ${this.isEditMode?"updated":"created"} successfully!`;alert(c),d.status==="completed"&&this.generateInvoice(),this.router.navigate(["base/jobs"])},error:c=>{console.error(`Error ${this.isEditMode?"updating":"creating"} job:`,c),alert(`Error ${this.isEditMode?"updating":"creating"} job. Please try again.`)}})}generateInvoice(){this.jobId&&this.jobService.generateInvoice(this.jobId).subscribe({next:()=>alert("Invoice generated and sent to customer"),error:e=>console.error("Failed to generate invoice:",e)})}markFormGroupTouched(e){Object.values(e.controls).forEach(i=>{i.markAsTouched(),(i instanceof ae||i instanceof ge)&&this.markFormGroupTouched(i)})}openAddCustomerModal(){this.customerForm.reset(),this.showAddCustomerModal=!0}onModalVisibleChange(e){this.showAddCustomerModal=e}saveNewCustomer(){if(this.customerForm.invalid||this.isSavingCustomer){this.markFormGroupTouched(this.customerForm);return}this.isSavingCustomer=!0,this.jobService.createCustomer(this.customerForm.value).subscribe({next:e=>{this.customers.unshift(e),this.jobForm.get("user_id")?.setValue(e.id),this.showAddCustomerModal=!1,this.customerForm.reset(),this.isSavingCustomer=!1,alert("Customer created successfully!")},error:e=>{console.error("Error creating customer:",e),this.showAddCustomerModal=!1,this.isSavingCustomer=!1,alert(e.message)}})}static{this.\u0275fac=function(i){return new(i||l)(C(Ce),C(x),C(R),C(L))}}static{this.\u0275cmp=A({type:l,selectors:[["app-addjob"]],features:[N([x])],decls:69,vars:15,consts:[["xs","12"],[1,"mb-4"],["cForm","",1,"row","g-3",3,"ngSubmit","formGroup"],["md","12"],["cLabel","","for","inputCustomer"],["cSelect","","id","inputCustomer","formControlName","user_id"],["value",""],[3,"value",4,"ngFor","ngForOf"],["cButton","","color","secondary","type","button",3,"click"],["class","text-danger",4,"ngIf"],["alignment","center",3,"visibleChange","visible"],["cModalTitle",""],[3,"formGroup"],[1,"g-3"],["md","6"],["cLabel","","for","fullName"],["type","text","cFormControl","","id","fullName","formControlName","full_name","placeholder","John Doe"],["cLabel","","for","phone"],["type","text","cFormControl","","id","phone","formControlName","phone","placeholder","+1234567890"],["cLabel","","for","email"],["type","email","cFormControl","","id","email","formControlName","email","placeholder","john@example.com"],["cLabel","","for","address"],["cFormControl","","id","address","formControlName","address","rows","2"],["cButton","","color","secondary",3,"click"],["cButton","","color","primary",3,"click"],["formArrayName","devices",1,"col-12"],["class","mb-4 p-3 border rounded",3,"formGroupName",4,"ngFor","ngForOf"],["cLabel","","for","estimatedDelivery"],["type","date","cFormControl","","id","estimatedDelivery","formControlName","estimated_delivery",3,"min"],["md","6",4,"ngIf"],[4,"ngIf"],["cLabel",""],[1,"form-control"],["cButton","","color","primary","type","submit"],[3,"value"],[1,"text-danger"],[1,"mb-4","p-3","border","rounded",3,"formGroupName"],["cLabel","",3,"for"],["cSelect","","formControlName","device_type",3,"id"],["cFormControl","","formControlName","problem_description","rows","3",3,"id"],["type","number","cFormControl","","formControlName","estimated_price","min","0","step","0.01",3,"id"],["type","text","cFormControl","","formControlName","serial_number","min","0","step","0.01",3,"id"],["type","checkbox","formControlName","needs_replacement",3,"change"],["xs","12",4,"ngIf"],["type","text","cFormControl","","formControlName","replacement_serial_number",3,"id","required"],["cButton","","color","danger","type","button",3,"click"],["cLabel","","for","status"],["cSelect","","id","status","formControlName","status"],["value","pending"],["value","in_progress"],["value","completed"],["cLabel","","for","paymentStatus"],["cSelect","","id","paymentStatus","formControlName","payment_status"],["value","paid"],["cLabel","","for","paymentMethod"],["cSelect","","id","paymentMethod","formControlName","payment_method"],["cLabel","","for","upiLink"],["type","url","cFormControl","","id","upiLink","formControlName","upi_link","placeholder","https://upi.link/..."]],template:function(i,n){if(i&1&&(o(0,"c-row")(1,"c-col",0)(2,"c-card",1)(3,"c-card-header"),r(4,`
        `),o(5,"strong"),r(6),t(),r(7,`
      `),t(),o(8,"c-card-body")(9,"form",2),h("ngSubmit",function(){return n.onSubmit()}),o(10,"c-col",3)(11,"label",4),r(12,"Customer *"),t(),o(13,"select",5)(14,"option",6),r(15,"Select customer..."),t(),_(16,xe,2,3,"option",7),t(),o(17,"button",8),h("click",function(){return n.openAddCustomerModal()}),r(18," + Add New "),t(),_(19,Se,2,0,"div",9),t(),o(20,"c-modal",10),h("visibleChange",function(p){return n.showAddCustomerModal=p}),o(21,"c-modal-header")(22,"h5",11),r(23,"Add New Customer"),t()(),o(24,"c-modal-body")(25,"form",12)(26,"c-row",13)(27,"c-col",14)(28,"label",15),r(29,"Full Name *"),t(),v(30,"input",16),t(),o(31,"c-col",14)(32,"label",17),r(33,"Phone *"),t(),v(34,"input",18),t(),o(35,"c-col",3)(36,"label",19),r(37,"Email"),t(),v(38,"input",20),t(),o(39,"c-col",3)(40,"label",21),r(41,"Address"),t(),v(42,"textarea",22),t()()()(),o(43,"c-modal-footer")(44,"button",23),h("click",function(){return n.showAddCustomerModal=!1}),r(45,"Cancel"),t(),o(46,"button",24),h("click",function(){return n.saveNewCustomer()}),r(47,"Save Customer"),t()()(),o(48,"div",25),_(49,De,32,16,"div",26),t(),o(50,"c-col",0)(51,"button",8),h("click",function(){return n.addDevice()}),r(52," + Add Another Device "),t()(),o(53,"c-col",14)(54,"label",27),r(55,"Estimated Delivery Date *"),t(),v(56,"input",28),_(57,Ne,2,0,"div",9),t(),_(58,ke,10,0,"c-col",29)(59,Re,15,3,"ng-container",30),o(60,"c-col",14)(61,"label",31),r(62,"Total Estimated Price"),t(),o(63,"div",32),r(64),y(65,"currency"),t()(),o(66,"c-col",0)(67,"button",33),r(68),t()()()()()()()),i&2){let d,p;a(6),M(n.isEditMode?"Edit Repair Job":"Create New Repair Job"),a(3),m("formGroup",n.jobForm),a(7),m("ngForOf",n.customers),a(3),m("ngIf",((d=n.jobForm.get("user_id"))==null?null:d.invalid)&&((d=n.jobForm.get("user_id"))==null?null:d.touched)),a(),m("visible",n.showAddCustomerModal),a(5),m("formGroup",n.customerForm),a(24),m("ngForOf",n.devices.controls),a(7),m("min",n.minDate),a(),m("ngIf",((p=n.jobForm.get("estimated_delivery"))==null?null:p.invalid)&&((p=n.jobForm.get("estimated_delivery"))==null?null:p.touched)),a(),m("ngIf",n.isEditMode),a(),m("ngIf",n.showPaymentForm&&n.isEditMode),a(5),g(" ",E(65,13,n.calculateTotalPrice())," "),a(4),g(" ",n.isEditMode?"Update Job":"Create Job"," ")}},dependencies:[q,k,V,w,P,G,Ee,me,be,ve,oe,de,ne,_e,re,le,fe,he,se,ue,ce,pe,ie,X,te,Y,Z,ee,W,Q,B,$,O,K,H,z,J,ye,U],encapsulation:2})}}return l})();export{mt as AddjobComponent};
